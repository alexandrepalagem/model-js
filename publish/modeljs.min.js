/*ModelJS v0.0.1 https://github.com/rafaeleyng/model-js*/var ModelJS=function(t,i){var e=this,s="id",n=function(){this.clean=function(){for(var t in localStorage)localStorage.removeItem(t)},this.count=function(t){return this._getIndex(t).length},this.find=function(t,i){var e=this._helpers.genKey(t,i),s=localStorage.getItem(e);return s?JSON.parse(s):void 0},this.first=function(t){if(0===this.count(t))return void 0;var i=this._getIndex(t),e=i[0];return this.find(t,e)},this.last=function(t){var i=this.count(t);if(0===i)return void 0;var e=this._getIndex(t),s=e[i-1];return this.find(t,s)},this.all=function(t){var i=this._getIndex(t),e=[];for(var s in i){var n=i[s];e.push(this.find(t,n))}return e},this.page=function(t,i,e){var s=e*i;if(s>=this.count(t))return[];var n=this._getIndex(t),r=n.slice(s,s+e),a=[];for(var o in r){var h=r[o];a.push(this.find(t,h))}return a},this.filter=function(t,i){return this.all(t).filter(i)},this.save=function(t,i){var e=i.id,s=this._helpers.genKey(t,e),n=null===localStorage.getItem(s);if(n){var r=this._getIndex(t),a=this._helpers.locationOf(e,r);a.found||(r.splice(a.location,0,e),this._saveIndex(t,r)),localStorage.setItem(this._idKey(t),e)}return localStorage.setItem(s,JSON.stringify(i)),n},this.delete=function(t,i){var e=this._helpers.genKey(t,i),s=this._getIndex(t),n=this._helpers.locationOf(i,s);return n.found?(s.splice(n.location,1),this._saveIndex(t,s),localStorage.removeItem(e),!0):!1},this._getIndex=function(t){var i=localStorage.getItem(t);return i?JSON.parse(i):[]},this._saveIndex=function(t,i){localStorage.setItem(t,JSON.stringify(i))},this._idKey=function(t){return t+e._ucFirst(s)},this.genId=function(t){var i=localStorage.getItem(this._idKey(t));return i?parseInt(i)+1:1},this._helpers={},this._helpers.genKey=function(t,i){return t+"_"+i},this._helpers.locationOf=function(t,i){for(var e=0,s=i.length-1,n=0,r=t,a=0;s>=e;){if(a++,n=(e+s)/2|0,r=i[n],t==r)return{found:!0,location:n};t>r?e=n+1:s=n-1}return t>r&&n++,{found:!1,location:n}}},r=function(t){var i=n;return"localStorage"===t?n:"webSQL"===t?void 0:"indexedDB"===t?void 0:i};this.config={storage:"localStorage",pluralization:{}};for(var a in i)void 0!==this.config[a]&&(this.config[a]=i[a]);this.config.base="_Base",this.config.defaultBase="_DefaultBase",t[this.config.defaultBase]=new ModelJS.SchemaEntity([s]);var o=r(this.config.storage);this.storage=new o,this.schema=t,this.Entity={},this.Entity[this.config.defaultBase]=function(t,i){for(var e in t)e===s?Object.defineProperty(this,s,{value:t[e],writable:!1,enumerable:!0}):this[e]=t[e];i&&(this.class=i)};for(var h in this.schema)h!==this.config.defaultBase&&(this.schema[h].attrs||(this.schema[h].attrs=[]),function(t){e.Entity[t]=function(i){e.Entity[e.config.defaultBase].call(this,i,t)}}(h));this._attrsForEntity=function(t){var i=this.schema[this.config.defaultBase].attrs,e=this.schema[this.config.base]?this.schema[this.config.base].attrs:[],s=this.schema[t].attrs;return i.concat(e).concat(s)},this.context={},this._getFromContext=function(t,i){return this.context[this._genKey(t,i.id)]},this._putInContext=function(t,i){var e=this._genKey(t,i.id);if(this._contextContains(t,i)){var n=this._attrsForEntity(t);for(var r in n){var a=n[r];a!==s&&(this.context[e][a]=i[a])}}else this.context[e]=i;return i},this._contextContains=function(t,i){return void 0!==this.context[t+"_"+i.id]},this._create=function(t,i){if(i=i||{},this._isCollection(i)){var e=[];for(var s in i)e.push(this._createOrGetFromContex(t,i[s]));return e}return this._createOrGetFromContex(t,i)},this._createOrGetFromContex=function(t,i){if(this._contextContains(t,i))return this._getFromContext(t,i);var e=this.Entity[t];return this._putInContext(t,new e(i))},this.count=function(t){return this.storage.count(t)},this.find=function(t,i){var e=this.storage.find(t,i);return e?this._create(t,e):void 0},this.first=function(t){return this._create(t,this.storage.first(t))},this.last=function(t){return this._create(t,this.storage.last(t))},this.all=function(t){return this._create(t,this.storage.all(t))},this.page=function(t,i,e){return this._create(t,this.storage.page(t,i,e))},this.filter=function(t,i){return i?this._create(t,this.storage.filter(t,i)):this.all(t)},this.exists=function(t,i){return void 0!==this.find(t,i)},this.save=function(t,i){if(void 0!==this.schema[t]){var e=this._filterData(t,i);if(this._isCollection(e)){var s=[];for(var n in e)e[n].id?this.exists(t,e[n].id)||(e[n].id=this._genId(t)):e[n].id=this._genId(t),s.push(this._save(t,e[n]));return s}return e.id?this.exists(t,e.id)||(e.id=this._genId(t)):e.id=this._genId(t),this._save(t,e)}},this._save=function(t,i){var n=this.storage.save(t,i),r=this.Entity[t],a=new r(i);if(this._putInContext(t,a),n){var o=this._pluralize(t);for(var h in this.context){var c=this.context[h],u=c[o];if(u&&c.id===a[this._lcFirst(c.class)+e._ucFirst(s)]){var f=!1;for(var l in u)if(u[l].id===a.id){f=!0;break}f||u.push(a)}}}return a},this.delete=function(t,i){delete this.context[this._genKey(t,i)];var e=this._pluralize(t);for(var s in this.context){var n=this.context[s],r=n[e];if(r)for(var a in r){var o=r[a];if(o.id===i){var h=parseInt(a);r.splice(h,1);break}}}this.storage.delete(t,i)},this.addTo=function(t,i){var n=this._pluralize(t.class),r=this._makeCollection(t),a=i[this._lcFirst(n)+e._ucFirst(s)],o=[];for(var h in r){var c=r[h];-1===a.indexOf(c.id)&&o.push(c)}i[n]=i[n].concat(o)},this.removeFrom=function(t,i){var e=this._pluralize(t.class),s=i[e];for(var n in s){var r=s[n];if(this.same(t,r)){s.splice(n,1);break}}i[e]=s},this.relatedTo=function(t,i){var e=this._pluralize(t.class),s=i[e];for(var n in s){var r=s[n];if(this.same(t,r))return!0}return!1},this.same=function(t,i){return t.class===i.class&&t.id===i.id},this.equals=function(t,i){if(!t.class||t.class!==i.class)return!1;var e=t.class,n=this._attrsForEntity(e);for(var r in n){var a=n[r];if(a!==s&&t[a]!==i[a])return!1}return!0},this._pluralize=function(t){return this.config.pluralization[t]||t+"s"},this._typeOf=function(t){return Object.prototype.toString.call(t).slice(8,-1)},this._isCollection=function(t){return"Array"===this._typeOf(t)},this._makeCollection=function(t){return this._isCollection(t)?t:[t]},this._lcFirst=function(t){return t.substr(0,1).toLowerCase()+t.substr(1,t.length)},this._ucFirst=function(t){return t.substr(0,1).toUpperCase()+t.substr(1,t.length)},this._genKey=function(t,i){return t+"_"+i},this._genId=function(t){return this.storage.genId(t)},this._filterData=function(t,i){var e=this._attrsForEntity(t);if(this._isCollection(i)){var s=[];for(var n in i){var r=i[n],a={};for(var o in r)e.indexOf(o)>-1&&(a[o]=r[o]);s.push(a)}return s}var a={};for(var o in i)-1!==e.indexOf(o)&&(a[o]=i[o]);return a};var c={directRelToOne:function(t){var i="_"+t,n=e._lcFirst(t),r=n+e._ucFirst(s),a="_"+r;Object.defineProperty(this,t,{get:function(){return this[i]||(this[i]=e.find(t,this[a])),this[i]},set:function(t){this[a]=t.id,this[i]=t}}),Object.defineProperty(this,r,{get:function(){return this[a]},set:function(t){this[a]=t,this[i]=void 0}})},directRelToMany:function(t,i){var n="_"+i,r=e._lcFirst(i),a=r+e._ucFirst(s),o="_"+a;Object.defineProperty(this,i,{get:function(){if(!this[n]){var i=this;this[n]=e.filter(t,function(t){return void 0===i[o]?!1:i[o].indexOf(t.id)>-1}),this[n]=this[n]||[]}return this[n]||[]},set:function(t){this[o]=e._makeCollection(t).map(function(t){return t.id}),this[n]=e._makeCollection(t)}}),Object.defineProperty(this,a,{get:function(){return this[o]||[]},set:function(t){this[o]=t,this[n]=void 0}})},inverseRel:function(t,i,n){var r="_"+n,a="_"+e._lcFirst(t)+e._ucFirst(s);Object.defineProperty(this,n,{get:function(){if(!this[r]){var t=this.id;this[r]=e.filter(i,function(i){return i[a]===t})}return this[r]}})},save:function(){e.save(this.class,this)},"delete":function(){e.delete(this.class,this.id)}};for(var h in this.Entity){var u=Object.create(c),f=this.schema[h].relsToOne;for(var l in f){var v=f[l];this.schema[h].attrs.push("_"+this._lcFirst(v)+e._ucFirst(s)),u.directRelToOne(v)}var d=this.schema[h].relsToMany;for(var l in d){var v=d[l],_=this._pluralize(v);this.schema[h].attrs.push("_"+this._lcFirst(_)+e._ucFirst(s)),u.directRelToMany(v,_)}for(var g in this.Entity){var p=this.schema[g].relsToOne;if(p&&p.indexOf(h)>-1){var m=this._pluralize(g);u.inverseRel(h,g,m)}}var y=this.Entity[h];y.prototype=u}};ModelJS.SchemaEntity=function(t,i,e){this.attrs=t||[],this.relsToOne=i||[],this.relsToMany=e||[]};
